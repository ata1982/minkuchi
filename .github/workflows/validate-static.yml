name: ğŸš€ Deploy Static Site to Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate HTML
      run: |
        echo "ğŸ” Validating HTML structure..."
        # Basic HTML validation
        if ! grep -q "<!DOCTYPE html>" static-site/index.html; then
          echo "âŒ Missing DOCTYPE declaration"
          exit 1
        fi
        if ! grep -q "<title>" static-site/index.html; then
          echo "âŒ Missing title tag"
          exit 1
        fi
        echo "âœ… HTML validation passed"
        
    - name: ğŸ¨ Validate CSS
      run: |
        echo "ğŸ¨ Validating CSS syntax..."
        # Check for basic CSS issues
        if grep -q "rgb(" static-site/styles.css && ! grep -q ")" static-site/styles.css; then
          echo "âŒ Unclosed CSS functions detected"
          exit 1
        fi
        echo "âœ… CSS validation passed"
        
    - name: âš¡ Validate JavaScript
      run: |
        echo "âš¡ Validating JavaScript syntax..."
        # Basic JS syntax check using Node.js
        node -c static-site/script.js
        echo "âœ… JavaScript validation passed"
        
    - name: ğŸ“Š Check file sizes
      run: |
        echo "ğŸ“Š Checking file sizes..."
        HTML_SIZE=$(wc -c < static-site/index.html)
        CSS_SIZE=$(wc -c < static-site/styles.css)
        JS_SIZE=$(wc -c < static-site/script.js)
        
        echo "ğŸ“„ HTML: ${HTML_SIZE} bytes"
        echo "ğŸ¨ CSS: ${CSS_SIZE} bytes"
        echo "âš¡ JS: ${JS_SIZE} bytes"
        
        TOTAL_SIZE=$((HTML_SIZE + CSS_SIZE + JS_SIZE))
        echo "ğŸ“¦ Total: ${TOTAL_SIZE} bytes"
        
        if [ $TOTAL_SIZE -gt 100000 ]; then
          echo "âš ï¸  Warning: Total size > 100KB, consider optimization"
        else
          echo "âœ… File sizes are optimal"
        fi
        
    - name: ğŸŒ Test static site locally
      run: |
        echo "ğŸŒ Testing static site..."
        cd static-site
        python3 -m http.server 8000 &
        SERVER_PID=$!
        sleep 3
        
        # Test if server responds
        if curl -f http://localhost:8000/ > /dev/null 2>&1; then
          echo "âœ… Static site serves correctly"
        else
          echo "âŒ Static site failed to serve"
          exit 1
        fi
        
        kill $SERVER_PID
        
    - name: ğŸš€ Deploy notification
      run: |
        echo "ğŸš€ Static site validated successfully!"
        echo "ğŸ“¡ Render.com will auto-deploy from this commit"
        echo "ğŸ”— Site URL: https://minkuchi-static.onrender.com"