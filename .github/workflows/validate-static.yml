name: 🚀 Deploy Static Site to Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🔍 Validate HTML
      run: |
        echo "🔍 Validating HTML structure..."
        # Basic HTML validation
        if ! grep -q "<!DOCTYPE html>" static-site/index.html; then
          echo "❌ Missing DOCTYPE declaration"
          exit 1
        fi
        if ! grep -q "<title>" static-site/index.html; then
          echo "❌ Missing title tag"
          exit 1
        fi
        echo "✅ HTML validation passed"
        
    - name: 🎨 Validate CSS
      run: |
        echo "🎨 Validating CSS syntax..."
        # Check for basic CSS issues
        if grep -q "rgb(" static-site/styles.css && ! grep -q ")" static-site/styles.css; then
          echo "❌ Unclosed CSS functions detected"
          exit 1
        fi
        echo "✅ CSS validation passed"
        
    - name: ⚡ Validate JavaScript
      run: |
        echo "⚡ Validating JavaScript syntax..."
        # Basic JS syntax check using Node.js
        node -c static-site/script.js
        echo "✅ JavaScript validation passed"
        
    - name: 📊 Check file sizes
      run: |
        echo "📊 Checking file sizes..."
        HTML_SIZE=$(wc -c < static-site/index.html)
        CSS_SIZE=$(wc -c < static-site/styles.css)
        JS_SIZE=$(wc -c < static-site/script.js)
        
        echo "📄 HTML: ${HTML_SIZE} bytes"
        echo "🎨 CSS: ${CSS_SIZE} bytes"
        echo "⚡ JS: ${JS_SIZE} bytes"
        
        TOTAL_SIZE=$((HTML_SIZE + CSS_SIZE + JS_SIZE))
        echo "📦 Total: ${TOTAL_SIZE} bytes"
        
        if [ $TOTAL_SIZE -gt 100000 ]; then
          echo "⚠️  Warning: Total size > 100KB, consider optimization"
        else
          echo "✅ File sizes are optimal"
        fi
        
    - name: 🌍 Test static site locally
      run: |
        echo "🌍 Testing static site..."
        cd static-site
        python3 -m http.server 8000 &
        SERVER_PID=$!
        sleep 3
        
        # Test if server responds
        if curl -f http://localhost:8000/ > /dev/null 2>&1; then
          echo "✅ Static site serves correctly"
        else
          echo "❌ Static site failed to serve"
          exit 1
        fi
        
        kill $SERVER_PID
        
    - name: 🚀 Deploy notification
      run: |
        echo "🚀 Static site validated successfully!"
        echo "📡 Render.com will auto-deploy from this commit"
        echo "🔗 Site URL: https://minkuchi-static.onrender.com"